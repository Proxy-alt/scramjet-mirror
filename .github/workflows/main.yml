name: Sync Folder from Parent Repo by Commit Date

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-folder:
    runs-on: ubuntu-latest

    env:
      PARENT_REPO: https://github.com/HeyPuter/browser.js
      SOURCE_FOLDER: packages/scramjet
      LAST_UPDATED_FILE: .github/.last_updated

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Read last updated timestamp
        id: read-timestamp
        run: |
          if [ -f "$LAST_UPDATED_FILE" ]; then
            LAST_UPDATED=$(cat "$LAST_UPDATED_FILE")
          else
            LAST_UPDATED="1970-01-01T00:00:00Z"
          fi
          echo "LAST_UPDATED=$LAST_UPDATED" >> $GITHUB_ENV

      - name: Clone parent repo
        run: |
          git clone "$PARENT_REPO" parent-repo
          cd parent-repo

      - name: Get latest commit date of source folder
        run: |
          cd parent-repo
          COMMIT_DATE=$(git log -1 --format="%cI" -- "$SOURCE_FOLDER")
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "Parent repo commit date: $COMMIT_DATE"
          echo "Stored last updated: $LAST_UPDATED"
      
      - name: Compare dates and sync if newer
        run: |
          COMMIT_EPOCH=$(date -d "$COMMIT_DATE" +%s)
          LAST_UPDATED_EPOCH=$(date -d "$LAST_UPDATED" +%s)
      
          if [[ $COMMIT_EPOCH -gt $LAST_UPDATED_EPOCH ]]; then
            echo "Changes detected. Syncing..."
            exit_code=0
            rsync -avL --copy-unsafe-links \
              --exclude='.github' --exclude='.git' \
              parent-repo/packages/scramjet ./ --ignore-errors || exit_code=$?
      
            if [[ "$exit_code" != "0" ]]; then
              echo "rsync failed with exit code $exit_code"
              exit $exit_code
            fi
      
            echo "$COMMIT_DATE" > "$LAST_UPDATED_FILE"
            echo "SHOULD_COMMIT=true" >> $GITHUB_ENV
          else
            echo "No changes detected."
            echo "SHOULD_COMMIT=false" >> $GITHUB_ENV
          fi
      
      - name: Clean up parent repo
        if: env.SHOULD_COMMIT == 'true'
        run: rm -rf parent-repo

      - name: Clean up parent repo
        if: env.SHOULD_COMMIT == 'true'
        run: rm -rf parent-repo

      - name: Commit and push if updated
        if: env.SHOULD_COMMIT == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          rm -rf parent-repo
          git add -A
          git reset -- parent-repo  # Ensure clone isn't staged

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Sync updates from parent repo ($SOURCE_FOLDER)"
            git push origin HEAD:${{ github.ref }}
          fi
