name: Sync Folder from Parent Repo by Commit Date

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:

permissions:
    contents: write
jobs:
  sync-folder:
    runs-on: ubuntu-latest

    env:
      PARENT_REPO: https://github.com/HeyPuter/browser.js
      SOURCE_FOLDER: packages/scramjet
      LAST_UPDATED_FILE: .github/.last_updated

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Read last updated timestamp
        id: read-timestamp
        run: |
          if [ -f "$LAST_UPDATED_FILE" ]; then
            LAST_UPDATED=$(cat "$LAST_UPDATED_FILE")
          else
            LAST_UPDATED="1970-01-01T00:00:00Z"
          fi
          echo "LAST_UPDATED=$LAST_UPDATED" >> $GITHUB_ENV

      - name: Clone parent repo shallow and sparse
        run: |
          git clone --depth=1 --filter=blob:none --sparse "$PARENT_REPO" parent-repo
          cd parent-repo
          git sparse-checkout set "$SOURCE_FOLDER"

      - name: Get latest commit date of source folder
        run: |
          cd parent-repo
          COMMIT_DATE=$(git log -1 --format="%cI" -- "$SOURCE_FOLDER")
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "Parent repo commit date: $COMMIT_DATE"
          echo "Stored last updated: $LAST_UPDATED"

      - name: Compare dates and sync if newer
        run: |
            if [[ "$COMMIT_DATE" > "$LAST_UPDATED" ]]; then
            echo "Changes detected. Syncing..."

            rsync -avL --copy-unsafe-links --exclude='.github' --exclude='.git' parent-repo/"$SOURCE_FOLDER"/ ./ --delete || exit_code=$?
            rm -rf parent-repo
            if [[ "$exit_code" != "" && "$exit_code" != "0" && "$exit_code" != "24" ]]; then
                echo "rsync failed with exit code $exit_code"
                exit $exit_code
            fi
            echo "$COMMIT_DATE" > "$LAST_UPDATED_FILE"
            echo "SHOULD_COMMIT=true" >> $GITHUB_ENV
            else
            echo "No changes detected."
            echo "SHOULD_COMMIT=false" >> $GITHUB_ENV
            fi

      - name: Commit and push if updated
        if: env.SHOULD_COMMIT == 'true'
        run: |
            rm -rf parent-repo  # Clean up clone to avoid nested repo issues

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            # Stage all changes except the parent-repo clone
            git add -A
            git reset -- parent-repo  # Unstage the embedded repo if it was added

            # Double-check that files were actually staged
            if git diff --cached --quiet; then
            echo "No changes to commit."
            else
            git commit -m "Sync updates from parent repo ($SOURCE_FOLDER)"
            git push
            fi
